<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock / Index App</title>
<style>
html, body {
    height: 100%; margin:0; font-family: Arial, sans-serif; background:#f5f5f5; color:#333;
    display: flex; flex-direction: column;
}

/* Top Bar */
.top-bar {
    display: flex; align-items: center; background:#222; color:white; padding:6px 10px;
    gap:6px; flex-wrap:wrap; position:sticky; top:0; z-index:1000;
}

.top-bar input, .top-bar select, .top-bar button {
    height:32px; padding:0 8px; border-radius:4px; border:none; font-size:12px; cursor:pointer;
    display:flex; align-items:center; /* vertical center */
}

.top-bar input[type="text"], .top-bar input[type="date"], .top-bar select {
    border:1px solid #ccc; border-radius:4px;
}

.top-bar button.active { background:#00aaff; color:white; }

#statusBox {
    margin-left:auto; font-size:11px; background:#444; padding:2px 6px;
    border-radius:4px; color:#fff; max-width:400px; overflow-x:auto; white-space:nowrap;
}

/* Backend / Frontend container */
.container {
    flex: 1; display: flex; flex-direction: row; gap:10px; padding:10px; overflow:hidden;
}

#backendDiv, #frontendDiv {
    flex: 1; background:#fff; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
    overflow:auto; padding:10px;
}

h3 { margin-top:0; color:#00aaff; font-size:16px; }

table { border-collapse:collapse; width:100%; margin:6px 0; font-size:13px; }
table, th, td { border:1px solid #aaa; }
th { background:#00aaff; color:white; padding:6px; text-align:left; }
td { padding:5px; }

@media (max-width:900px){
    .container { flex-direction: column; }
    #backendDiv, #frontendDiv { flex: none; height: 50%; }
    .top-bar input, .top-bar select, .top-bar button { font-size:11px; height:28px; }
    h3 { font-size:14px; }
}
</style>
</head>
<body>

<div class="top-bar">
    <button id="btnStock" class="active" onclick="setMode('stock')">Stock</button>
    <button id="btnIndex" onclick="setMode('index')">Index</button>

    <input id="symbolInput" type="text" value="ITC" style="width:90px;">
    <select id="reqType" style="width:130px"></select>
    <input id="dateInput" type="date" style="width:120px;">
    <button id="fetchBtn" onclick="fetchNow()" style="background:#2196f3;color:white;">Fetch</button>

    <button id="btnBackend" class="active" onclick="setSide('backend')">Backend</button>
    <button id="btnFrontend" onclick="setSide('frontend')">Frontend</button>

    <div id="statusBox">No fetch yet</div>
</div>

<div class="container">
    <div id="backendDiv"><h3>Backend Output</h3></div>
    <div id="frontendDiv"><h3>Frontend Extracted Tables</h3><p>No tables yet.</p></div>
</div>

<script type="module">
import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

let currentMode = "stock";
let currentSide = "backend";
let appClient = null;

const reqOptions = {
    stock: [ "info", "intraday", "daily","nse_eq", "qresult", "result", "balance",
        "cashflow", "dividend", "split", "other","stock_hist"],
    index: [ "indices", "nse_open", "nse_preopen", "nse_fno","nse_fiidii","nse_events",
        "nse_future", "nse_bhav", "nse_highlow","index_history","nse_largedeals",
        "nse_most_active","largedeals_historical","nse_bulkdeals",
        "nse_blockdeals","index_pe_pb_div","index_total_returns"]
};

// ---------------- DEFAULT DATE ----------------
function setDefaultDate(){
    const d = new Date();
    d.setDate(d.getDate() - 1);
    document.getElementById("dateInput").value = d.toISOString().split("T")[0];
}
setDefaultDate();

// ---------------- POPULATE DROPDOWN ----------------
function populateReqType(){
    const dropdown = document.getElementById("reqType");
    dropdown.innerHTML = reqOptions[currentMode].map(x=>`<option value="${x}">${x}</option>`).join('');
}
populateReqType();

// ---------------- CONNECT HF CLIENT ----------------
async function connectClient(){
    if(appClient) return appClient;
    try {
        appClient = await Client.connect("eshan6704/backend");
        return appClient;
    } catch(e){ appClient=null; return null; }
}

// ---------------- UPDATE STATUS ----------------
function updateStatus(status, sizeKB=0){
    const name = document.getElementById("symbolInput").value;
    const req_type = document.getElementById("reqType").value;
    const mode = currentMode;
    const dateVal = document.getElementById("dateInput").value.split("-").reverse().join("-");

    const now = new Date();
    const ts = now.toLocaleTimeString("en-GB", { hour12:false });
    const sizeInfo = sizeKB > 0 ? ` | ${sizeKB} KB` : "";

    document.getElementById("statusBox").innerText = 
        `${mode},${req_type},${name},${dateVal} | Last fetch: ${ts} | ${status}${sizeInfo}`;
}

// ---------------- FETCH ----------------
window.fetchNow = async function(){
    const name = document.getElementById("symbolInput").value;
    const req_type = document.getElementById("reqType").value;
    const rawDate = document.getElementById("dateInput").value;
    const date = rawDate.split("-").reverse().join("-");

    const backendDiv = document.getElementById("backendDiv");
    const frontendDiv = document.getElementById("frontendDiv");
    backendDiv.innerHTML = "<h3>Backend Output</h3>";
    frontendDiv.innerHTML = "<h3>Frontend Extracted Tables</h3>";

    const client = await connectClient();
    if(!client){ 
        backendDiv.innerHTML += "<p style='color:red;'>Unable to connect to backend</p>"; 
        updateStatus("Error", 0);
        return; 
    }

    let result;
    try {
        result = await client.predict("/fetch_data",[currentMode, req_type, name, date]);
        let sizeKB = 0;
        if(result){
            const str = JSON.stringify(result);
            sizeKB = (new Blob([str]).size / 1024).toFixed(2);
        }
        updateStatus("Success", sizeKB);
    } catch(err){
        backendDiv.innerHTML += `<p style='color:red;'>Backend error: ${err.message}</p>`;
        updateStatus("Error", 0);
        return;
    }

    const blocks = result.data || [];
    const fragBackend = document.createDocumentFragment();
    const fragTables = document.createDocumentFragment();

    blocks.forEach(block=>{
        const div = document.createElement("div");
        div.innerHTML = block;
        fragBackend.appendChild(div);
        fragBackend.appendChild(document.createElement("hr"));

        const temp = document.createElement("div");
        temp.innerHTML = block;
        temp.querySelectorAll("table").forEach(tbl=>{
            fragTables.appendChild(tbl.cloneNode(true));
            fragTables.appendChild(document.createElement("hr"));
        });
    });

    backendDiv.appendChild(fragBackend);
    frontendDiv.appendChild(fragTables);
    if(!frontendDiv.querySelector("table")) frontendDiv.innerHTML += "<p>No tables found.</p>";
    updateSideDisplay();
};

// ---------------- MODE / VIEW ----------------
window.setMode = function(mode){
    currentMode = mode;
    document.getElementById("btnStock").classList.toggle("active", mode==="stock");
    document.getElementById("btnIndex").classList.toggle("active", mode==="index");
    populateReqType();
    document.getElementById("symbolInput").value = (mode==="index") ? "NIFTY 50" : "ITC";
    document.getElementById("backendDiv").innerHTML="<h3>Backend Output</h3>";
    document.getElementById("frontendDiv").innerHTML="<h3>Frontend Extracted Tables</h3><p>No tables yet.</p>";
};

window.setSide = function(side){
    currentSide = side;
    updateSideDisplay();
};
function updateSideDisplay(){
    document.getElementById("btnBackend").classList.toggle("active", currentSide==="backend");
    document.getElementById("btnFrontend").classList.toggle("active", currentSide==="frontend");
    document.getElementById("backendDiv").style.display = (currentSide==="backend") ? "block" : "none";
    document.getElementById("frontendDiv").style.display = (currentSide==="frontend") ? "block" : "none";
}

document.getElementById("symbolInput").addEventListener("keypress", e=>{ if(e.key==="Enter") fetchNow(); });

setMode("stock"); 
updateSideDisplay();
</script>

</body>
</html>
